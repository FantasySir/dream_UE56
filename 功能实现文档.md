# dream_UE56 功能实现文档

## 1. 框架总览
本项目基于UE5.6，采用GAS（Gameplay Ability System）实现战斗、单位管理、属性系统、UI分层等功能，支持C++与蓝图扩展。

## 2. 基础设定
### 2.1 玩法简单描述
玩家控制主角在场景中探索，敌人会生成在场景中巡逻，主角或敌人遭受攻击后才会进入战斗，主角可以在敌人没有发现时锁定敌人，并通过一些技能键召唤单位背刺敌人进入战斗，敌人巡逻发现主角会追逐主角，如果主角受到一次攻击或在敌人追逐主角时召唤单位，则进入战斗。
在战斗中，主角在召唤单位全部死亡前是不会受到伤害的，主角召唤单位生命值全部为0时，敌人将可以攻击主角，主角死亡则战斗失败，敌人全部死亡则战斗胜利。
### 2.2 路径
默认.cpp路径:Source/dream_UE56/Private
默认.h路径:Source/dream_UE56/Public
任意类/接口路径的含义：其头文件存放在[默认.h路径/类或接口路径中],cpp文件存放在[默认.cpp路径/类或接口路径中]，例如EWPlayerController的路径是Player，其路径分别为[Source/dream_UE56/Private/Player]和[Source/dream_UE56/Private/Player]。
### 2.3 关于EW前缀
EW是EnternalWitness的简写，是项目的代号，你新生成的类可以加入该前缀

### 目录结构（2025/08/22 最新）
```
Source/dream_UE56/
├── Private/
│   ├── AbilitySystem/
│   │   ├── AttributeSets/
│   │   │   ├── EWBaseAttributeSet.cpp
│   │   │   ├── EWPlayerAttributeSet.cpp
│   │   │   ├── EWCombatAttributeSet.cpp
│   │   │   └── EWUnitAttributeSet.cpp
│   │   ├── GameplayEffects/
│   │   │   ├── EWDefaultAttributeEffect.cpp
│   │   │   └── EWGameplayEffect_ActionPointCost.cpp
│   │   └── Abilities/
│   │       └── EWGameplayAbility_TimePause.cpp
│   ├── Components/
│   │   └── EWTimePauseImmuneComponent.cpp
│   ├── Core/
│   │   ├── EWGameplayTags.cpp
│   │   └── EWTimeFunctionLibrary.cpp
│   └── Gameplay/
│       └── EWTimeManager.cpp
├── Public/
│   ├── AbilitySystem/
│   │   ├── AttributeSets/
│   │   │   ├── EWBaseAttributeSet.h
│   │   │   ├── EWPlayerAttributeSet.h
│   │   │   ├── EWCombatAttributeSet.h
│   │   │   └── EWUnitAttributeSet.h
│   │   ├── GameplayEffects/
│   │   │   ├── EWDefaultAttributeEffect.h
│   │   │   └── EWGameplayEffect_ActionPointCost.h
│   │   └── Abilities/
│   │       └── EWGameplayAbility_TimePause.h
│   ├── Components/
│   │   └── EWTimePauseImmuneComponent.h
│   ├── Core/
│   │   ├── EWGameplayTags.h
│   │   └── EWTimeFunctionLibrary.h
│   └── Gameplay/
│       └── EWTimeManager.h
```

---

## 3. 主要系统与类

### 3.1 角色与单位系统
- **EWCharacterBase**
  - 玩家主角基类，支持时间暂停、单位召唤、目标锁定等功能。
  - 集成GAS，拥有能力系统和属性集。
  - 默认免疫时间暂停效果。
- **EWUnitBase**
  - 战斗单位基类，具备阵营、AI、战斗、技能等功能。
  - 支持敌我识别、AI行为树集成。
  - 自动注册到时间管理系统，受时间暂停影响。
- **EWUnitAttributeSet**
  - 单位属性集，包含血量、法力、行动点、攻击/防御/暴击等战斗属性。
  - 支持属性变更事件、网络同步。

### 3.2 时间暂停系统
- **EWTimeManager**（WorldSubsystem）
  - 精确控制游戏时间暂停，支持Actor级别的时间控制
  - 玩家角色默认免疫时间暂停，其他单位受暂停影响
  - 自动管理时间敏感Actor的注册和注销
- **EWTimePauseImmuneComponent**
  - 组件化的时间暂停免疫系统
  - 支持蓝图配置，可动态设置免疫状态
- **EWGameplayAbility_TimePause**
  - 基于GAS的时间暂停技能
  - 支持行动点消耗、冷却时间、自动恢复
- **EWTimeFunctionLibrary**
  - 蓝图函数库，提供便捷的时间控制接口
  - 支持编辑器内调用

### 3.3 单位管理系统
- **EWUnitManager**
  - 管理玩家拥有的全部单位（n个）与可参战单位（m个）。
  - 支持单位槽位配置、召唤消耗计算、单位状态跟踪。

### 3.4 输入系统
- **EWPlayerController**
  - 使用Enhanced Input，支持战斗、时间控制、单位召唤、UI交互等输入。
  - 可扩展自定义输入动作。

### 3.5 标签系统
- **EWGameplayTags**
  - 标准化的GameplayTag定义
  - 涵盖能力、状态、单位类型、事件、效果等分类
  - 支持原生标签初始化

### 3.6 UI框架
- **WidgetController层**
  - `EWOverlayWidgetController`：HUD主控
  - `EWAttributeMenuWidgetController`：属性菜单控制
  - `EWUnitManagementWidgetController`：单位管理控制
- **Widget层**
  - `EWUserWidget`：基础UI控件
  - `EWAttributeProgressBar`：属性进度条
  - `EWUnitSlotWidget`：单位槽位控件
  - `EWMessageWidget`：消息提示控件
- **EWHUD**
  - HUD管理类，负责Widget创建、控制器绑定、显示/隐藏等

---

## 4. 主要功能点


### 已实现功能（2025/08/22）
- **GAS集成**：角色和单位均拥有能力系统与属性集，支持GameplayEffect与GameplayAbility扩展。
- **属性集拆分**：基础属性、玩家专属属性、战斗属性分离，便于扩展和维护。
- **目录重构**：所有GAS相关代码已归类至AbilitySystem目录。
- **时间暂停系统**：
  - **EWTimeManager**：世界子系统，精确控制时间暂停，玩家角色免疫暂停效果
  - **EWTimePauseImmuneComponent**：组件化的时间暂停免疫系统，支持蓝图配置
  - **EWGameplayAbility_TimePause**：基于GAS的时间暂停技能，支持行动点消耗和冷却
  - **EWTimeFunctionLibrary**：蓝图函数库，提供便捷的时间控制接口
  - 玩家可控制游戏时间暂停与恢复，其他单位和技能被暂停，玩家自身不受影响
- **单位召唤系统**：玩家可配置参战单位并消耗行动点进行召唤。
- **目标锁定系统**：支持锁定/切换目标，便于战斗操作。
- **单位管理**：支持单位槽位拖拽、参战配置、召唤消耗显示。
- **UI分层架构**：WidgetController与Widget分离，支持属性事件驱动、数据绑定。
- **输入系统**：支持多种输入动作，便于扩展和自定义。
- **GameplayTag体系**：标准化的标签系统，用于能力、状态、事件管理。

---

## 5. 下一步 ToDoList

### 时间暂停系统相关
1. 【蓝图】创建时间暂停能力的蓝图派生类，配置消耗和冷却参数
2. 【蓝图】为特殊技能效果（如粒子系统、音效等）添加时间暂停免疫组件
3. 【C++/蓝图】优化时间暂停的视觉反馈（如慢动作效果、UI提示等）
4. 【蓝图】在玩家控制器中绑定时间暂停输入动作

### UI与属性系统
5. 【蓝图】实现各属性集的UI绑定（血量、法力、体力、行动点、攻击/防御等）
6. 【蓝图】实现单位召唤消耗的动态显示与动画反馈
7. 【蓝图】实现属性变更事件驱动的UI刷新（如进度条、数值文本）
8. 【蓝图】实现单位槽位拖拽与参战配置逻辑

### GAS系统完善
9. 【C++/蓝图】补充更多GameplayAbility与GameplayEffect的蓝图示例
10. 【蓝图】使用标准化GameplayTag替换硬编码字符串
11. 【C++/蓝图】完善行动点消耗的GameplayEffect实现

### AI与战斗系统
12. 【C++/蓝图】完善AI行为树与单位技能系统
13. 【C++/蓝图】实现战斗状态下的时间暂停逻辑
14. 【蓝图】为敌方AI添加时间暂停状态的响应逻辑

### 用户体验
15. 【蓝图】丰富UI动画与交互体验
16. 【C++/蓝图】增加本地化与数据驱动支持
17. 【蓝图】添加时间暂停的音效和视觉特效

---

## 6. GameplayTag 增加建议

### 推荐Tag列表（可根据实际需求扩展）
- Unit.Type.Player
- Unit.Type.Enemy
- Unit.Type.Boss
- Ability.Type.Attack
- Ability.Type.Defense
- Ability.Type.Heal
- Ability.Type.Special
- Status.Stunned
- Status.Poisoned
- Status.Invincible
- Event.OnSummon
- Event.OnDeath

### 如何添加GameplayTag
1. 在内容浏览器中新建 `GameplayTag` 数据表（或在项目设置中管理Tag）
2. 在C++或蓝图中引用Tag：
  - C++：`FGameplayTag::RequestGameplayTag(TEXT("Unit.Type.Player"))`
  - 蓝图：使用 `Make Gameplay Tag` 节点或直接在属性中选择Tag
3. 在Ability/Effect/属性集等逻辑中使用Tag进行判定、触发、过滤

### 推荐Tag用途
- 单位类型判定（玩家/敌人/首领）
- 技能类型分类（攻击/防御/治疗/特殊）
- 状态效果标记（眩晕/中毒/无敌等）
- 事件触发（召唤/死亡/复活等）

---

## 7. 蓝图实现建议

1. 属性集与UI绑定：在WidgetController蓝图中监听属性变化事件，驱动进度条和数值文本刷新。
2. 单位召唤消耗：在单位管理Widget中动态显示消耗，支持动画反馈。
3. 槽位拖拽：实现单位槽位拖拽逻辑，支持参战配置与消耗计算。
4. GameplayTag判定：在蓝图中通过Tag判定单位类型、技能类型、状态效果，实现更灵活的逻辑分支。
5. GameplayAbility与Effect：建议用蓝图派生基础C++类，便于策划快速迭代。

---

如需详细教程，请参考《UI框架使用教程.md》。

---

## 8. 扩展性说明

- **蓝图扩展**：所有核心类均支持蓝图派生，便于美术和策划自定义。
- **属性事件驱动**：属性变化自动驱动UI刷新，支持动画、音效等扩展。
- **AI行为树**：单位AI可通过行为树和黑板自定义。
- **UI样式与动画**：Widget可扩展动画、样式、本地化等。
- **数据驱动**：单位、属性、UI均可通过DataTable等数据资源配置。

---

## 9. 典型用法示例

- 创建蓝图WidgetController，绑定属性事件，实现UI与底层数据交互。
- 在HUD蓝图中配置各类Widget和Controller，实现多层UI管理。
- 在PlayerController中绑定输入动作，实现UI弹窗、单位召唤等功能。
- 单位管理界面支持拖拽配置参战单位，自动计算召唤消耗。

---

## 10. 时间暂停系统使用指南

### C++使用方式
```cpp
// 获取时间管理器
UEWTimeManager* TimeManager = GetWorld()->GetSubsystem<UEWTimeManager>();

// 暂停时间
if (TimeManager && CanPauseTime())
{
    TimeManager->PauseTime(this);
}

// 恢复时间
if (TimeManager)
{
    TimeManager->ResumeTime();
}

// 设置Actor免疫时间暂停
TimeManager->RegisterTimeSensitiveActor(SomeActor);
```

### 蓝图使用方式
1. **暂停/恢复时间**：使用`EWTimeFunctionLibrary`中的`Pause Game Time`和`Resume Game Time`节点
2. **检查暂停状态**：使用`Is Game Time Paused`节点
3. **设置免疫**：为Actor添加`EWTimePauseImmuneComponent`组件
4. **技能使用**：通过GAS系统激活`EWGameplayAbility_TimePause`能力

### 组件配置
- **EWTimePauseImmuneComponent**：
  - `Is Time Pause Immune`：是否免疫时间暂停
  - `Auto Register On Begin Play`：是否在BeginPlay时自动注册

### 注意事项
- 玩家角色（EWCharacterBase）默认免疫时间暂停
- 所有EWUnitBase会自动注册到时间管理系统
- 使用时间暂停能力会消耗行动点并触发冷却
- 可以为特殊效果（粒子、音效等）添加免疫组件

---

## 11. 后续建议

- 补充GameplayEffect与GameplayAbility蓝图示例
- 完善AI行为树和技能系统
- 丰富UI动画与交互体验
- 增加本地化与数据驱动支持

---

如需详细教程，请参考《UI框架使用教程.md》。

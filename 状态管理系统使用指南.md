# 状态管理系统使用指南

## 概述

状态管理系统实现了数据与表现分离的设计模式，允许角色被销毁的同时保留其数据用于复活。

## 核心类说明

### EWBaseState (基础状态类)
- **用途**: 所有状态类的基类，提供GAS集成和生命周期管理
- **主要功能**:
  - AbilitySystemComponent 管理
  - 属性集管理
  - 角色生成与销毁
  - 状态标签管理
  - 数据同步

### EWPlayerState (玩家状态类)
- **用途**: 管理玩家的持久化数据
- **主要功能**:
  - 玩家等级和经验管理
  - 单位管理 (召唤、复活等)
  - 资源管理 (金币、行动点等)
  - 成就系统

### EWUnitState (单位状态类)
- **用途**: 管理单位的持久化数据
- **主要功能**:
  - 单位等级和经验管理
  - 装备系统
  - 复活系统
  - 职业和派系管理
  - 召唤成本计算

## 使用示例

### 1. 创建单位状态

```cpp
// 在玩家状态中创建新单位
UEWUnitState* NewUnit = UEWPlayerState::CreateUnitState(UnitClass);
NewUnit->SetUnitName(TEXT("战士"));
NewUnit->SetFaction(EFaction::Player);
NewUnit->SetUnitClass(EUnitClass::Warrior);
```

### 2. 召唤单位

```cpp
// 在指定位置召唤单位
FVector SpawnLocation = FVector(100, 200, 0);
FRotator SpawnRotation = FRotator::ZeroRotator;

AActor* SummonedCharacter = PlayerState->SummonUnit(UnitState, SpawnLocation, SpawnRotation);
if (SummonedCharacter)
{
    UE_LOG(LogTemp, Log, TEXT("单位召唤成功"));
}
```

### 3. 处理单位死亡

```cpp
// 单位死亡时自动处理
// - 角色Actor被销毁
// - 状态数据保留
// - 自动开始复活倒计时

// 检查复活状态
if (UnitState->IsReviving())
{
    float TimeRemaining = UnitState->GetRevivalTimeRemaining();
    UE_LOG(LogTemp, Log, TEXT("复活倒计时: %.1f秒"), TimeRemaining);
}
```

### 4. 手动复活单位

```cpp
// 手动复活单位 (例如使用复活道具)
UnitState->Revive(0.5f); // 复活时恢复50%血量
```

### 5. 获取单位信息

```cpp
// 获取单位基础信息
FString UnitName = UnitState->GetUnitName();
EFaction Faction = UnitState->GetFaction();
int32 Level = UnitState->GetUnitLevel();
float Experience = UnitState->GetExperience();

// 获取单位属性 (需要先实现属性)
// float Attack = UnitState->GetAttack();
// float Defense = UnitState->GetDefense();
```

## 待完善功能

### 1. 属性系统扩展
需要在 `UEWUnitAttributeSet` 中添加以下属性：
```cpp
// 在 EWUnitAttributeSet.h 中添加
UPROPERTY(BlueprintReadOnly, Category = "Combat")
FGameplayAttributeData Attack;
ATTRIBUTE_ACCESSORS(UEWUnitAttributeSet, Attack)

UPROPERTY(BlueprintReadOnly, Category = "Combat")
FGameplayAttributeData Defense;
ATTRIBUTE_ACCESSORS(UEWUnitAttributeSet, Defense)

UPROPERTY(BlueprintReadOnly, Category = "Combat")
FGameplayAttributeData CriticalChance;
ATTRIBUTE_ACCESSORS(UEWUnitAttributeSet, CriticalChance)

UPROPERTY(BlueprintReadOnly, Category = "Combat")
FGameplayAttributeData CriticalMultiplier;
ATTRIBUTE_ACCESSORS(UEWUnitAttributeSet, CriticalMultiplier)
```

### 2. AEWUnitBase扩展
需要在单位基类中添加以下方法：
```cpp
// 在 EWUnitBase.h 中添加
UFUNCTION(BlueprintCallable)
void SetUnitClass(EUnitClass NewClass);

UFUNCTION(BlueprintPure)
EUnitClass GetUnitClass() const;

UFUNCTION(BlueprintCallable)
void SetUnitData(class UEWUnitData* Data);
```

### 3. 数据类创建
创建 `UEWUnitData` 类用于配置单位初始数据：
```cpp
UCLASS(BlueprintType)
class UEWUnitData : public UDataAsset
{
    GENERATED_BODY()
    
public:
    UPROPERTY(EditAnywhere, BlueprintReadOnly)
    FString UnitName;
    
    UPROPERTY(EditAnywhere, BlueprintReadOnly)
    EUnitClass DefaultClass;
    
    UPROPERTY(EditAnywhere, BlueprintReadOnly)
    float BaseAttack;
    
    // ... 其他配置
};
```

## 蓝图集成

所有核心功能都标记了 `UFUNCTION(BlueprintCallable)` 或 `UFUNCTION(BlueprintPure)`，可以直接在蓝图中使用：

1. **Get Unit State** - 获取单位状态
2. **Summon Unit** - 召唤单位  
3. **Revive Unit** - 复活单位
4. **Get Revival Time Remaining** - 获取复活倒计时
5. **Add Experience** - 增加经验

## 注意事项

1. **内存管理**: 状态对象会自动管理生命周期，不需要手动删除
2. **网络同步**: 状态类支持网络同步，属性变化会自动同步到客户端
3. **持久化**: 状态数据可以保存到存档文件中
4. **性能考虑**: 大量单位时建议使用对象池来复用Actor实例

## 扩展建议

1. **装备系统**: 完善装备槽位功能，实现装备效果应用
2. **技能系统**: 集成GAS技能系统，支持技能学习和升级
3. **AI集成**: 为单位状态添加AI行为配置
4. **视觉效果**: 添加召唤、复活等动画效果
5. **UI系统**: 创建单位管理界面显示状态信息
